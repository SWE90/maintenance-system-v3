// Prisma Schema for Maintenance System V3
// PostgreSQL Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  admin
  supervisor
  technician
  customer
  workshop
}

enum UserStatus {
  active
  inactive
  suspended
}

enum TicketStatus {
  new
  assigned
  scheduled
  on_route
  arrived
  inspecting
  diagnosed
  repairing
  waiting_parts
  pickup_device
  in_workshop
  ready_delivery
  completed
  not_fixed
  cancelled
}

enum Priority {
  low
  normal
  high
  urgent
}

enum DeviceType {
  ac
  washer
  fridge
  oven
  dishwasher
  other
}

enum WarrantyStatus {
  yes
  no
  unknown
}

enum TimeSlot {
  morning
  noon
  evening
}

enum AttachmentType {
  before_inspection
  after_repair
  serial_photo
  invoice_photo
  parts_photo
  device_photo
  signature
  other
}

enum MessageChannel {
  internal
  sms
  whatsapp
  email
}

enum MessageStatus {
  pending
  sent
  delivered
  read
  failed
}

enum PartsRequestStatus {
  pending
  approved
  ordered
  received
  cancelled
}

enum EscalationLevel {
  L1
  L2
  L3
}

enum EscalationType {
  assignment_delay
  schedule_delay
  trip_delay
  arrival_delay
  parts_delay
  completion_delay
  customer_complaint
  sla_breach
}

enum SmsStatus {
  pending
  sent
  delivered
  failed
}

enum SmsType {
  otp
  tracking_link
  verification_code
  notification
  reminder
  visit_reminder
  completion_otp
}

enum AuditAction {
  create
  update
  delete
  login
  logout
  transition
  assign
  schedule
  send_sms
  escalate
  resolve_escalation
}

// ============================================
// USERS & AUTH
// ============================================

model User {
  id          Int        @id @default(autoincrement())
  email       String?    @unique
  phone       String?    @unique
  password    String?
  name        String
  nameAr      String?    @map("name_ar")
  role        UserRole   @default(customer)
  status      UserStatus @default(active)
  employeeId  String?    @unique @map("employee_id")
  department  String?
  avatar      String?

  // Customer specific fields
  address     String?
  city        String?
  district    String?
  lat         Float?
  lng         Float?

  // Technician specific fields
  specializations String[]
  serviceAreas    String[]    @map("service_areas")
  isAvailable     Boolean     @default(true) @map("is_available")
  currentLat      Float?      @map("current_lat")
  currentLng      Float?      @map("current_lng")
  lastLocationAt  DateTime?   @map("last_location_at")

  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  deletedAt   DateTime?  @map("deleted_at")

  // Relations
  refreshTokens     RefreshToken[]
  otpCodes          OtpCode[]
  ticketsAsCustomer Ticket[]       @relation("CustomerTickets")
  ticketsAsTechnician Ticket[]     @relation("TechnicianTickets")
  ticketsAssignedBy Ticket[]       @relation("AssignedByUser")
  ticketsCreatedBy  Ticket[]       @relation("CreatedByUser")
  statusHistoryActor TicketStatusHistory[] @relation("StatusHistoryActor")
  timeLogs          TimeLog[]
  locations         TechnicianLocation[]
  smsLogs           SmsLog[]
  auditLogs         AuditLog[]
  messagesAsSender  TicketMessage[] @relation("MessageSender")
  partsRequestsBy   PartsRequest[] @relation("PartsRequestedBy")
  escalationsOwner  Escalation[] @relation("EscalationOwner")
  escalationsResolved Escalation[] @relation("EscalationResolvedBy")
  ratingsGiven      Rating[]

  @@index([role])
  @@index([status])
  @@index([city])
  @@map("users")
}

model RefreshToken {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model OtpCode {
  id         Int       @id @default(autoincrement())
  userId     Int?      @map("user_id")
  phone      String
  code       String
  type       String    @default("login")
  attempts   Int       @default(0)
  maxAttempts Int      @default(3) @map("max_attempts")
  expiresAt  DateTime  @map("expires_at")
  verifiedAt DateTime? @map("verified_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone])
  @@index([code])
  @@index([type])
  @@map("otp_codes")
}

// ============================================
// TICKETS
// ============================================

model Ticket {
  id              Int          @id @default(autoincrement())
  ticketNumber    String       @unique @map("ticket_number")
  trackingToken   String       @unique @map("tracking_token")

  // Customer Info (denormalized for quick access)
  customerId      Int          @map("customer_id")
  customerName    String       @map("customer_name")
  customerPhone   String       @map("customer_phone")
  customerEmail   String?      @map("customer_email")
  customerCity    String       @map("customer_city")
  customerAddress String       @map("customer_address") @db.Text
  latitude        Float
  longitude       Float

  // Device Info
  deviceType         DeviceType
  brand              String
  model              String?
  problemDescription String     @map("problem_description") @db.Text

  // Warranty Info
  warrantyStatus  WarrantyStatus @default(unknown) @map("warranty_status")
  invoiceNumber   String?        @map("invoice_number")
  serialNumber    String?        @map("serial_number")

  // Scheduling
  preferredTimeSlot   TimeSlot?    @map("preferred_time_slot")
  scheduledDate       DateTime?    @map("scheduled_date")
  scheduledTimeSlot   TimeSlot?    @map("scheduled_time_slot")

  // Assignment
  technicianId   Int?      @map("technician_id")
  assignedAt     DateTime? @map("assigned_at")
  assignedById   Int?      @map("assigned_by_id")

  // Status & Priority
  status         TicketStatus @default(new)
  priority       Priority     @default(normal)

  // Diagnosis & Repair Notes
  diagnosisNotes    String?   @map("diagnosis_notes") @db.Text
  repairNotes       String?   @map("repair_notes") @db.Text
  internalNotes     String?   @map("internal_notes") @db.Text

  // Completion Info
  completedSuccessfully Boolean?  @map("completed_successfully")
  notFixedReasons       String[]  @map("not_fixed_reasons")
  cancellationReason    String?   @map("cancellation_reason")

  // Customer Confirmation
  customerSignature    String?   @map("customer_signature") @db.Text
  customerOtpVerified  Boolean   @default(false) @map("customer_otp_verified")
  customerRating       Int?      @map("customer_rating")
  customerFeedback     String?   @map("customer_feedback") @db.Text

  // Timestamps
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  scheduledSetAt     DateTime? @map("scheduled_set_at")
  tripStartedAt      DateTime? @map("trip_started_at")
  arrivedAt          DateTime? @map("arrived_at")
  inspectionStartedAt DateTime? @map("inspection_started_at")
  diagnosedAt        DateTime? @map("diagnosed_at")
  repairStartedAt    DateTime? @map("repair_started_at")
  completedAt        DateTime? @map("completed_at")
  cancelledAt        DateTime? @map("cancelled_at")

  // Created By (could be customer, admin, or system)
  createdById    Int?      @map("created_by_id")

  // Relations
  customer        User @relation("CustomerTickets", fields: [customerId], references: [id])
  technician      User? @relation("TechnicianTickets", fields: [technicianId], references: [id])
  assignedBy      User? @relation("AssignedByUser", fields: [assignedById], references: [id])
  createdBy       User? @relation("CreatedByUser", fields: [createdById], references: [id])
  statusHistory   TicketStatusHistory[]
  attachments     TicketAttachment[]
  messages        TicketMessage[]
  partsRequests   PartsRequest[]
  escalations     Escalation[]
  timeLogs        TimeLog[]
  locations       TicketLocation[]
  smsLogs         SmsLog[]
  ratings         Rating[]

  @@index([customerId])
  @@index([technicianId])
  @@index([status])
  @@index([priority])
  @@index([customerCity])
  @@index([deviceType])
  @@index([createdAt])
  @@index([scheduledDate])
  @@index([trackingToken])
  @@map("tickets")
}

// ============================================
// TICKET STATUS HISTORY (Timeline)
// ============================================

model TicketStatusHistory {
  id          Int           @id @default(autoincrement())
  ticketId    Int           @map("ticket_id")
  fromStatus  TicketStatus? @map("from_status")
  toStatus    TicketStatus  @map("to_status")
  notes       String?       @db.Text
  actorId     Int?          @map("actor_id")
  actorName   String        @map("actor_name")
  actorRole   UserRole      @map("actor_role")
  latitude    Float?
  longitude   Float?
  createdAt   DateTime      @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  actor  User?  @relation("StatusHistoryActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([toStatus])
  @@index([createdAt])
  @@map("ticket_status_history")
}

// ============================================
// ATTACHMENTS
// ============================================

model TicketAttachment {
  id              Int            @id @default(autoincrement())
  ticketId        Int            @map("ticket_id")
  type            AttachmentType
  url             String
  filename        String
  originalName    String         @map("original_name")
  mimeType        String         @map("mime_type")
  size            Int
  uploadedById    Int            @map("uploaded_by_id")
  uploadedByName  String         @map("uploaded_by_name")
  createdAt       DateTime       @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([type])
  @@map("ticket_attachments")
}

// ============================================
// MESSAGES / COMMUNICATION
// ============================================

model TicketMessage {
  id          Int           @id @default(autoincrement())
  ticketId    Int           @map("ticket_id")
  senderId    Int           @map("sender_id")
  senderName  String        @map("sender_name")
  senderRole  UserRole      @map("sender_role")
  content     String        @db.Text
  channel     MessageChannel @default(internal)
  externalId  String?       @map("external_id")
  status      MessageStatus @default(sent)
  readAt      DateTime?     @map("read_at")
  createdAt   DateTime      @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender User   @relation("MessageSender", fields: [senderId], references: [id])

  @@index([ticketId])
  @@index([senderId])
  @@index([channel])
  @@map("ticket_messages")
}

// ============================================
// SPARE PARTS REQUESTS
// ============================================

model PartsRequest {
  id              Int                @id @default(autoincrement())
  ticketId        Int                @map("ticket_id")
  partName        String             @map("part_name")
  partNumber      String?            @map("part_number")
  quantity        Int                @default(1)
  notes           String?            @db.Text
  photos          String[]
  status          PartsRequestStatus @default(pending)
  requestedById   Int                @map("requested_by_id")
  requestedByName String             @map("requested_by_name")
  requestedAt     DateTime           @default(now()) @map("requested_at")
  approvedAt      DateTime?          @map("approved_at")
  approvedById    Int?               @map("approved_by_id")
  orderedAt       DateTime?          @map("ordered_at")
  receivedAt      DateTime?          @map("received_at")
  cancelledAt     DateTime?          @map("cancelled_at")
  cancellationReason String?         @map("cancellation_reason")

  ticket      Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  requestedBy User   @relation("PartsRequestedBy", fields: [requestedById], references: [id])

  @@index([ticketId])
  @@index([status])
  @@index([requestedAt])
  @@map("parts_requests")
}

// ============================================
// ESCALATIONS
// ============================================

model Escalation {
  id              Int              @id @default(autoincrement())
  ticketId        Int              @map("ticket_id")
  level           EscalationLevel
  type            EscalationType
  reason          String           @db.Text
  ownerId         Int?             @map("owner_id")
  ownerName       String?          @map("owner_name")
  isResolved      Boolean          @default(false) @map("is_resolved")
  resolvedAt      DateTime?        @map("resolved_at")
  resolvedById    Int?             @map("resolved_by_id")
  resolvedByName  String?          @map("resolved_by_name")
  resolutionNotes String?          @map("resolution_notes") @db.Text
  createdAt       DateTime         @default(now()) @map("created_at")

  ticket     Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  owner      User?  @relation("EscalationOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  resolvedBy User?  @relation("EscalationResolvedBy", fields: [resolvedById], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([isResolved])
  @@index([level])
  @@index([type])
  @@index([createdAt])
  @@map("escalations")
}

// ============================================
// TIME TRACKING
// ============================================

model TimeLog {
  id              Int          @id @default(autoincrement())
  ticketId        Int          @map("ticket_id")
  technicianId    Int?         @map("technician_id")
  stage           TicketStatus
  startedAt       DateTime     @default(now()) @map("started_at")
  endedAt         DateTime?    @map("ended_at")
  durationMinutes Int?         @map("duration_minutes")

  ticket     Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  technician User?  @relation(fields: [technicianId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([technicianId])
  @@index([stage])
  @@map("time_logs")
}

// ============================================
// LOCATION TRACKING
// ============================================

model TechnicianLocation {
  id           Int      @id @default(autoincrement())
  technicianId Int      @map("technician_id")
  ticketId     Int?     @map("ticket_id")
  latitude     Float
  longitude    Float
  accuracy     Float?
  speed        Float?
  heading      Float?
  createdAt    DateTime @default(now()) @map("created_at")

  technician User @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([technicianId])
  @@index([ticketId])
  @@index([createdAt])
  @@map("technician_locations")
}

model TicketLocation {
  id        Int          @id @default(autoincrement())
  ticketId  Int          @map("ticket_id")
  status    TicketStatus
  latitude  Float
  longitude Float
  address   String?
  createdAt DateTime     @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([status])
  @@map("ticket_locations")
}

// ============================================
// RATINGS
// ============================================

model Rating {
  id           Int      @id @default(autoincrement())
  ticketId     Int      @map("ticket_id")
  customerId   Int      @map("customer_id")
  technicianId Int?     @map("technician_id")
  score        Int      // 1-5
  feedback     String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  customer User   @relation(fields: [customerId], references: [id])

  @@unique([ticketId])
  @@index([customerId])
  @@index([technicianId])
  @@index([score])
  @@map("ratings")
}

// ============================================
// SLA CONFIGURATION
// ============================================

model SlaConfig {
  id               Int             @id @default(autoincrement())
  name             String          @unique
  nameAr           String?         @map("name_ar")
  type             EscalationType
  thresholdMinutes Int             @map("threshold_minutes")
  escalationLevel  EscalationLevel @map("escalation_level")
  isActive         Boolean         @default(true) @map("is_active")
  description      String?         @db.Text
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  @@map("sla_configs")
}

// ============================================
// SMS LOGS
// ============================================

model SmsLog {
  id           Int       @id @default(autoincrement())
  ticketId     Int?      @map("ticket_id")
  userId       Int?      @map("user_id")
  phone        String
  message      String    @db.Text
  type         SmsType
  status       SmsStatus @default(pending)
  provider     String?
  providerId   String?   @map("provider_id")
  errorMessage String?   @map("error_message")
  sentAt       DateTime? @map("sent_at")
  deliveredAt  DateTime? @map("delivered_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  ticket Ticket? @relation(fields: [ticketId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([userId])
  @@index([phone])
  @@index([status])
  @@index([type])
  @@map("sms_logs")
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id          Int         @id @default(autoincrement())
  userId      Int?        @map("user_id")
  action      AuditAction
  entityType  String      @map("entity_type")
  entityId    Int?        @map("entity_id")
  oldData     Json?       @map("old_data")
  newData     Json?       @map("new_data")
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")
  createdAt   DateTime    @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model Setting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String   @db.Text
  type        String   @default("string")
  group       String?
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([group])
  @@map("settings")
}

// ============================================
// CITIES (for dropdowns)
// ============================================

model City {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  nameEn    String   @map("name_en")
  nameAr    String   @map("name_ar")
  region    String?
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([isActive])
  @@index([sortOrder])
  @@map("cities")
}
